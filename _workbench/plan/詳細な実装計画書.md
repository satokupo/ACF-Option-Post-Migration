# ACF Migrator プラグイン改修 - 詳細実装計画書

## 実装概要

既存の acf-migrator.php を通常のWordPressプラグインとして動作するように改修します。

---

## フェーズ0: 準備作業

### タスク
- [ ] 0.1. acf-migrator.php.backup を作成
- [ ] 0.2. 既存コードの構造を確認
- [ ] 0.3. 実装計画の最終確認

### フェーズ0完了
- [ ] **フェーズ0完了**

### 作業報告
```
バックアップ名:
既存行数:
```

---

## フェーズ1: プラグインヘッダーの更新

### タスク
- [ ] 1.1. ヘッダーを読み込み
- [ ] 1.2. Plugin Name を「ACF Option → Post Migration」に更新
- [ ] 1.3. Description を「ACFフィールド値を移行する管理画面ツール。ドライラン機能付き。使用後は削除してください。」に更新
- [ ] 1.4. Version を「2.0」に更新
- [ ] 1.5. Author を「satokupo helper」に更新
- [ ] 1.6. Requires PHP を「8.0」に更新
- [ ] 1.7. 更新の確認

### フェーズ1完了
- [ ] **フェーズ1完了**

### 作業報告
```
更新内容:
```

---

## フェーズ2: 既存コードの削除

### タスク
- [ ] 2.1. 15-18行目（設定変数）を確認
- [ ] 2.2. 21-106行目（admin_init）を削除
- [ ] 2.3. 削除後の確認

### フェーズ2完了
- [ ] **フェーズ2完了**

### 作業報告
```
削除行数:
```

---

## フェーズ3: 管理画面メニューの追加

### タスク
- [ ] 3.1. 挿入位置を確認
- [ ] 3.2. admin_menu フックと acf_migrator_add_menu 関数を追加
- [ ] 3.3. 追加コードの確認

### フェーズ3完了
- [ ] **フェーズ3完了**

### 作業報告
```
挿入位置:
```

---

## フェーズ4: 処理ロジックの関数化

### タスク
- [ ] 4.1. acf_migrator_execute 関数の準備
- [ ] 4.2. 関数シグネチャとACFチェック
- [ ] 4.3. レポート器とグループ処理ループ
- [ ] 4.4. 追加コードの確認

### フェーズ4完了
- [ ] **フェーズ4完了**

### 作業報告
```
関数の行数:
```

---

## フェーズ5: グループセレクターの解析ロジック

### タスク
- [ ] 5.1. スタブコードの位置を確認
- [ ] 5.2. 3つの分岐ロジックを実装（all / JSON配列 / 単一キー）
- [ ] 5.3. 確認

### フェーズ5完了
- [ ] **フェーズ5完了**

### 作業報告
```
分岐数: 3
```

---

## フェーズ6-7: 設定画面のHTML構築

### タスク
- [ ] 6.1. acf_migrator_settings_page 関数と基本構造（権限チェック、wrap div、h1タイトル）
- [ ] 6.2. フォーム開始タグと wp_nonce_field の追加
- [ ] 7.1. フォーム項目1: 移行元ID（source_post_id）
  - type="text"、name="source_post_id"、id="source_post_id"
  - デフォルト値: 'option'
  - class="regular-text"
  - value 属性で `esc_attr($_POST['source_post_id'] ?? 'option')` を使用して値を再表示
  - 説明文: 「オプションページの場合は 'option'、投稿からの場合は投稿ID」
- [ ] 7.2. フォーム項目2: 移行先ID（target_post_id）
  - type="number"、name="target_post_id"、id="target_post_id"
  - required 属性を追加
  - class="regular-text"
  - value 属性で `esc_attr($_POST['target_post_id'] ?? '')` を使用して値を再表示
  - 説明文: 「コピー先の投稿ID（必須）」
- [ ] 7.3. フォーム項目3: グループセレクター（group_selector）
  - type="text"、name="group_selector"、id="group_selector"
  - デフォルト値: 'group_xxxxxxxxxx'
  - required 属性を追加
  - class="regular-text"
  - value 属性で `esc_attr($_POST['group_selector'] ?? 'group_xxxxxxxxxx')` を使用して値を再表示
  - 説明文: 「単一: 'group_xxx'、複数: ['group_xxx','group_yyy']、全て: 'all'（必須）」
- [ ] 7.4. フォーム項目4: ドライランモード（dry_run）
  - type="checkbox"、name="dry_run"、value="1"
  - デフォルトでチェック済み状態にする（checked() 関数を使用）
  - checked(!isset($_POST['acf_migrator_submit']) || isset($_POST['dry_run'])) で状態を制御
  - ラベルテキスト: 「試走モード（書き込みなし、レポートのみ）」
- [ ] 7.5. 送信ボタンの追加
  - submit_button() 関数を使用
  - ラベル: 「移行を実行」
  - タイプ: 'primary'（プライマリボタン）
  - name: 'acf_migrator_submit'
- [ ] 7.6. フォーム終了タグ
- [ ] 7.7. 確認

### フェーズ6-7完了
- [ ] **フェーズ6-7完了**

### 作業報告
```
フォーム項目数: 4
送信ボタン: プライマリボタン「移行を実行」
```

---

## フェーズ8: フォーム送信処理

### タスク
- [ ] 8.1. isset チェック、ノンス検証、サニタイズ、関数呼び出し
- [ ] 8.2. 確認

### フェーズ8完了
- [ ] **フェーズ8完了**

### 作業報告
```
実装完了
```

---

## フェーズ9: レポート表示機能

### タスク
- [ ] 9.1. レポート表示の条件分岐（$report が存在する場合のみ表示）
- [ ] 9.2. h2 タグで「実行レポート」見出しを追加
- [ ] 9.3. textarea 要素の追加
  - readonly 属性を設定（編集不可）
  - style="width:100%"（幅100%）
  - style="height:500px"（高さ500px）
  - style="font-family:monospace"（等幅フォント）
  - style="font-size:12px"（フォントサイズ12px）
- [ ] 9.4. JSON エンコード処理
  - json_encode() 関数を使用
  - JSON_UNESCAPED_UNICODE フラグ（日本語をそのまま表示）
  - JSON_PRETTY_PRINT フラグ（整形して見やすく表示）
- [ ] 9.5. esc_textarea() でエスケープ処理
- [ ] 9.6. 確認

### フェーズ9完了
- [ ] **フェーズ9完了**

### 作業報告
```
テキストエリアサイズ: 100% × 500px
フォント: monospace 12px
JSON整形: UNESCAPED_UNICODE + PRETTY_PRINT
```

---

## フェーズ10: 不要な関数の削除

### タスク
- [ ] 10.1. output_json_and_exit を削除
- [ ] 10.2. 確認

### フェーズ10完了
- [ ] **フェーズ10完了**

### 作業報告
```
削除完了
```

---

## フェーズ11: コード全体の確認

### タスク
- [ ] 11.1. ファイル全体の確認
- [ ] 11.2. php -l で構文チェック
- [ ] 11.3. コードレビュー

### フェーズ11完了
- [ ] **フェーズ11完了**

### 作業報告
```
構文チェック結果:
```

---

## フェーズ12: テスト環境での動作確認

### タスク
- [ ] 12.1. プラグイン有効化
- [ ] 12.2. 管理画面メニュー確認
- [ ] 12.3. 設定画面表示確認
- [ ] 12.4. ドライラン実行テスト
- [ ] 12.5. エラーハンドリング確認
- [ ] 12.6. 本番実行テスト（オプション）

### フェーズ12完了
- [ ] **フェーズ12完了**

### 作業報告
```
テスト環境:
使用した投稿ID:
使用したグループキー:
結果:
```

---

## フェーズ13: readme.md の更新

### タスク
- [ ] 13.1. readme.md の確認
- [ ] 13.2. 使い方セクションの更新
- [ ] 13.3. その他のセクション更新
- [ ] 13.4. 更新の実行と確認

### フェーズ13完了
- [ ] **フェーズ13完了**

### 作業報告
```
更新したセクション:
```

---

## フェーズ14: 最終確認

### タスク
- [ ] 14.1. 全ファイルの確認
- [ ] 14.2. 実装計画書の完了マーク
- [ ] 14.3. 変更内容のサマリー作成
- [ ] 14.4. ユーザーへの報告準備

### フェーズ14完了
- [ ] **フェーズ14完了**

### 作業報告
```
最終確認完了
```

---

## 全体完了チェック

- [ ] **全フェーズ完了**

---

## 実装完了後のチェックリスト

- [ ] プラグインが正常に有効化できる
- [ ] 管理画面メニューに「ACF Migrator」が表示される
- [ ] 設定画面が正しく表示される
- [ ] フォームのバリデーションが動作する
- [ ] ドライランが正しく動作する
- [ ] 本番実行が正しく動作する
- [ ] レポートが正しく表示される
- [ ] readme.mdが更新されている
- [ ] PHP構文エラーがない
