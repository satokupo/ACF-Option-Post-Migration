# ACF Migrator プラグイン改修計画

## 現在の問題点

- プラグインを有効化すると `admin_init` フックで即座にJSONレポートを出力して `exit` するため、管理画面が使えなくなる
- 設定を変更するには毎回PHPファイルを編集する必要がある
- 一時的なツールだが、使い勝手が悪い

## 改修目標

通常のWordPressプラグインとして動作し、専用の管理画面で設定・実行できるようにする。

## 必要な変更内容

### 1. フックの変更

**現在:**
```php
add_action('admin_init', function () use ($DRY_RUN, $TARGET_POST_ID, $GROUP_SELECTOR) {
  // 即座に実行して exit
});
```

**変更後:**
- `admin_init` での即時実行を削除
- `admin_menu` フックで管理画面メニューを追加
- フォーム送信時のみ処理を実行

### 2. 管理画面メニューの追加

**追加するコード:**
```php
add_action('admin_menu', 'acf_migrator_add_menu');

function acf_migrator_add_menu() {
  add_options_page(
    'ACF Migrator',              // ページタイトル
    'ACF Migrator',              // メニュータイトル
    'manage_options',            // 権限
    'acf-migrator',              // スラッグ
    'acf_migrator_settings_page' // コールバック関数
  );
}
```

**メニュー位置:** 設定 > ACF Migrator（歯車アイコン配下）

### 3. 設定画面の作成

**必要な要素:**

#### フォーム項目
1. **移行元ID（SOURCE_POST_ID）**
   - タイプ: テキスト入力
   - デフォルト値: `'option'`
   - 説明: オプションページの場合は `'option'`、特定の投稿からコピーする場合は投稿ID

2. **移行先ID（TARGET_POST_ID）**
   - タイプ: 数値入力
   - 必須項目
   - 説明: コピー先の投稿ID

3. **グループセレクター（GROUP_SELECTOR）**
   - タイプ: テキスト入力
   - デフォルト値: `'group_xxxxxxxxxx'`（必須）
   - 説明: 単一グループの場合は `'group_xxx'`、複数グループの場合は `['group_xxx','group_yyy']` 形式、全グループの場合は `'all'`

4. **ドライランモード（DRY_RUN）**
   - タイプ: チェックボックス
   - デフォルト: チェック済み（true）
   - 説明: チェックありで試走、なしで本番実行

5. **実行ボタン**
   - ラベル: 「移行を実行」
   - プライマリボタン

#### レポート表示エリア
- テキストエリア（readonly）
- 幅: 100%
- 高さ: 500px
- フォント: monospace
- 実行後にJSONレポートを表示

### 4. HTMLフォームの構造

```php
function acf_migrator_settings_page() {
  // 権限チェック
  if (!current_user_can('manage_options')) {
    wp_die('権限がありません');
  }

  // フォーム送信処理
  $report = null;
  if (isset($_POST['acf_migrator_submit'])) {
    check_admin_referer('acf_migrator_action', 'acf_migrator_nonce');
    
    $source_post_id = sanitize_text_field($_POST['source_post_id']);
    $target_post_id = intval($_POST['target_post_id']);
    $group_selector = sanitize_text_field($_POST['group_selector']);
    $dry_run = isset($_POST['dry_run']);
    
    // 移行処理を実行
    $report = acf_migrator_execute($source_post_id, $target_post_id, $group_selector, $dry_run);
  }
  
  // HTML出力
  ?>
  <div class="wrap">
    <h1><span class="dashicons dashicons-admin-settings"></span> ACF Migrator</h1>
    <p>ACFフィールド値を移行します。まずドライランで確認してから本番実行してください。</p>
    
    <form method="post" action="">
      <?php wp_nonce_field('acf_migrator_action', 'acf_migrator_nonce'); ?>
      
      <table class="form-table">
        <tr>
          <th scope="row"><label for="source_post_id">移行元ID</label></th>
          <td>
            <input type="text" name="source_post_id" id="source_post_id" 
                   value="<?php echo esc_attr($_POST['source_post_id'] ?? 'option'); ?>" 
                   class="regular-text">
            <p class="description">オプションページの場合は 'option'、投稿からの場合は投稿ID</p>
          </td>
        </tr>
        <tr>
          <th scope="row"><label for="target_post_id">移行先ID</label></th>
          <td>
            <input type="number" name="target_post_id" id="target_post_id" 
                   value="<?php echo esc_attr($_POST['target_post_id'] ?? ''); ?>" 
                   class="regular-text" required>
            <p class="description">コピー先の投稿ID（必須）</p>
          </td>
        </tr>
        <tr>
          <th scope="row"><label for="group_selector">グループセレクター</label></th>
          <td>
            <input type="text" name="group_selector" id="group_selector"
                   value="<?php echo esc_attr($_POST['group_selector'] ?? 'group_xxxxxxxxxx'); ?>"
                   class="regular-text" required>
            <p class="description">単一: 'group_xxx'、複数: ['group_xxx','group_yyy']、全て: 'all'（必須）</p>
          </td>
        </tr>
        <tr>
          <th scope="row">ドライランモード</th>
          <td>
            <label>
              <input type="checkbox" name="dry_run" value="1" 
                     <?php checked(!isset($_POST['acf_migrator_submit']) || isset($_POST['dry_run'])); ?>>
              試走モード（書き込みなし、レポートのみ）
            </label>
          </td>
        </tr>
      </table>
      
      <?php submit_button('移行を実行', 'primary', 'acf_migrator_submit'); ?>
    </form>
    
    <?php if ($report): ?>
    <h2>実行レポート</h2>
    <textarea readonly style="width:100%;height:500px;font-family:monospace;font-size:12px;"><?php 
      echo esc_textarea(json_encode($report, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT)); 
    ?></textarea>
    <?php endif; ?>
  </div>
  <?php
}
```

### 5. 処理ロジックの関数化

**現在の `admin_init` 内のコードを別関数に切り出す:**

```php
function acf_migrator_execute($source_post_id, $target_post_id, $group_selector, $dry_run) {
  // ACF存在チェック
  if (!function_exists('acf_get_field_groups') || !function_exists('acf_get_fields')) {
    return ['error' => 'ACFが有効化されていません'];
  }
  
  // レポート器
  $report = [
    'dry_run'        => $dry_run,
    'source_post_id' => $source_post_id,
    'target_post_id' => $target_post_id,
    'timestamp'      => gmdate('c'),
    'groups'         => [],
    'totals'         => [
      'groups'   => 0,
      'fields'   => 0,
      'non_empty'=> 0,
      'updated'  => 0,
      'failed'   => 0,
      'skipped'  => 0,
      'would_update' => 0,
    ],
  ];
  
  // ... 既存の処理ロジックをここに移動 ...
  // （group_selectorの解析部分も含む）
  
  return $report;
}
```

### 6. グループセレクターの解析改善

**現在:** `$GROUP_SELECTOR` 変数を直接使用

**変更後:** 文字列として受け取り、単一グループ、配列形式、'all' を解析

```php
// グループセレクターの解析
if ($group_selector === 'all') {
  // 全グループを対象
  $target_groups = $groups;
} elseif (strpos($group_selector, '[') === 0) {
  // JSON配列形式として解析を試みる（例: ["group_xxx","group_yyy"]）
  $parsed = json_decode($group_selector, true);
  if (is_array($parsed)) {
    $allowed = array_flip($parsed);
    foreach ($groups as $g) {
      if (!empty($g['key']) && isset($allowed[$g['key']])) {
        $target_groups[] = $g;
      }
    }
  }
} else {
  // 単一グループキー（例: "group_xxx"）
  foreach ($groups as $g) {
    if (!empty($g['key']) && $g['key'] === $group_selector) {
      $target_groups[] = $g;
      break;
    }
  }
}
```

### 7. ファイル構造の変更

**現在のコード削除部分:**
- 15〜18行目の設定変数（`$DRY_RUN`, `$TARGET_POST_ID`, `$GROUP_SELECTOR`）
- 21〜106行目の `add_action('admin_init', ...)` 全体

**追加する部分:**
1. 管理画面メニュー追加（`add_action('admin_menu', ...)`）
2. 設定画面表示関数（`acf_migrator_settings_page()`）
3. 実行処理関数（`acf_migrator_execute()`）
4. 既存のヘルパー関数はそのまま維持

### 8. セキュリティ対策

- ✅ ノンス検証: `wp_nonce_field()` と `check_admin_referer()`
- ✅ 権限チェック: `current_user_can('manage_options')`
- ✅ 入力値のサニタイズ:
  - `sanitize_text_field()` for text inputs
  - `intval()` for numeric inputs
  - `esc_attr()` for output
  - `esc_textarea()` for textarea output

### 9. 改修後の動作フロー

1. プラグイン有効化 → 通常の管理画面が表示される
2. 管理画面 > 設定 > ACF Migrator にアクセス
3. フォームに値を入力
   - 移行元ID: `'option'`（デフォルト）
   - 移行先ID: 投稿ID（必須入力）
   - グループセレクター: `'group_xxxxxxxxxx'`（デフォルト、必須入力）
   - ドライランモード: チェック済み（デフォルト）
4. 「移行を実行」ボタンをクリック
5. レポートがテキストエリアに表示される
6. 問題なければドライランのチェックを外して再実行
7. 完了後、プラグインを削除

### 10. プラグインヘッダーの更新

```php
/**
 * Plugin Name: ACF Option → Post Migration
 * Description: ACFフィールド値を移行する管理画面ツール。ドライラン機能付き。使用後は削除してください。
 * Version:     2.0
 * Author:      satokupo helper
 * Requires PHP: 8.0
 */
```

## 実装手順

1. 既存の `admin_init` フックとその内容を削除
2. 処理ロジックを `acf_migrator_execute()` 関数に切り出し
3. `add_action('admin_menu', ...)` で管理画面メニューを追加
4. `acf_migrator_settings_page()` 関数で設定画面のHTMLを作成
5. フォーム送信処理を実装
6. ヘルパー関数（`enumerate_and_process_field()` 等）はそのまま維持
7. 動作確認
8. readme.mdの使い方セクションを更新

## 注意点

- 既存のヘルパー関数（`enumerate_and_process_field()`, `summarize_value()`, `sample_array()`）は変更不要
- `output_json_and_exit()` 関数は不要になるため削除
- `$source_post_id` を追加して、'option' 以外からの移行にも対応可能に
- グループセレクターの形式:
  - 単一グループ: `'group_xxx'`（デフォルト）
  - 複数グループ: JSON配列文字列 `["group_xxx","group_yyy"]`
  - 全グループ: `'all'`
