# ACF Option → Post Migration (Dry-run first)

WordPressのACF（Advanced Custom Fields）で管理している「オプションページ」の値を、特定の投稿・固定ページ・カスタム投稿タイプに移行するための一時的なツールプラグインです。

## 概要

このプラグインは、ACFのオプションページ（`'option'`）に保存されているフィールド値を、指定した投稿IDに一括コピーします。移行前にドライラン（試走）モードで動作確認ができ、ネストしたフィールド構造もJSON形式で詳細にレポート表示します。

## 主な機能

- **ドライランモード**: 実際に書き込む前に、移行対象のフィールドと値をJSONレポートで確認可能
- **フィールドグループ選択**: 全グループ一括、または特定グループのみを選択可能
- **ネスト構造対応**: Group、Repeater、Flexible Content、Cloneなどの複雑なフィールド構造に対応
- **詳細レポート**: フィールドツリー、値のプレビュー、更新状況を階層構造で表示
- **安全設計**: 管理者権限チェック、投稿IDの存在確認を実施

## 対応フィールドタイプ

- 通常のフィールド（テキスト、画像、リレーションシップなど）
- Group（グループ）
- Repeater（リピーター）
- Flexible Content（フレキシブルコンテンツ）
- Clone（クローン）

## 使い方

### 1. 設定の編集

`acf-migrator.php` の15〜18行目にある設定値を編集します:

```php
$DRY_RUN        = true;                     // true=試走（書き込みなし） / false=本番（書き込み）
$TARGET_POST_ID = 12345;                    // 移設先の投稿ID（固定/CPT）
$GROUP_SELECTOR = 'all';                    // 'all' もしくは ['group_abcd1234','group_efgh5678']
```

- **$DRY_RUN**:
  - `true` = ドライラン（書き込まずにレポートのみ表示）
  - `false` = 本番実行（実際に値を書き込み）
- **$TARGET_POST_ID**: 移行先の投稿ID（数値）
- **$GROUP_SELECTOR**:
  - `'all'` = すべてのフィールドグループを対象
  - `['group_xxx', 'group_yyy']` = 特定のグループのみを対象（グループキーの配列）

### 2. ドライラン実行

1. `$DRY_RUN = true;` の状態でプラグインを有効化
2. 管理者権限でWordPress管理画面にアクセス
3. 画面にJSONレポートが表示されます
4. レポート内容を確認:
   - `would_update`: 移行予定のフィールド
   - `skipped`: 空値でスキップされたフィールド
   - `totals`: 集計情報

### 3. 本番実行

1. レポート内容に問題がなければ、`$DRY_RUN = false;` に変更
2. 再度管理画面にアクセス
3. `updated`（成功）または `failed`（失敗）のステータスを確認

### 4. プラグインの削除

移行完了後は、このプラグインを削除してください（セキュリティのため）。

## JSONレポートの見方

```json
{
  "dry_run": true,
  "target_post_id": 123,
  "timestamp": "2025-11-13T06:27:00+00:00",
  "totals": {
    "groups": 2,           // 処理したグループ数
    "fields": 15,          // 総フィールド数
    "non_empty": 10,       // 空でないフィールド数
    "would_update": 10,    // 移行予定（ドライラン時）
    "updated": 0,          // 更新成功（本番実行時）
    "failed": 0,           // 更新失敗
    "skipped": 5           // スキップ（空値）
  },
  "groups": [
    {
      "group_key": "group_xxx",
      "group_title": "基本設定",
      "tree": [
        {
          "label": "サイト名",
          "name": "site_name",
          "key": "field_yyy",
          "type": "text",
          "value": {
            "type": "string",
            "size": "string(10)",
            "preview": "サンプルサイト"
          },
          "result": "would_update"
        }
      ]
    }
  ]
}
```

## 注意事項

- **一時的なプラグイン**: 移行作業専用です。使用後は必ず削除してください
- **バックアップ必須**: 実行前にデータベースのバックアップを取得してください
- **管理者権限**: 管理者としてログインしている必要があります
- **ACF必須**: Advanced Custom Fields（無料版またはPRO版）が有効化されている必要があります
- **既存値の上書き**: 移行先の投稿に既存のACF値がある場合、上書きされます

## システム要件

- WordPress 5.0以上
- PHP 8.0以上（`get_debug_type()` 関数を使用）
- Advanced Custom Fields 5.x / 6.x

## 技術詳細

### 処理フロー

1. `admin_init` フックで実行（管理画面アクセス時）
2. 権限チェック（`manage_options` 権限必須）
3. 対象グループの取得と絞り込み
4. フィールド定義を再帰的に走査
5. 各フィールドの値を `'option'` から取得
6. ドライランモードに応じて `update_field()` 実行または予定記録
7. JSON形式でレポート出力して終了

### 再帰処理対応

`enumerate_and_process_field()` 関数により、以下のネスト構造を再帰的に処理します：

- **Group**: `sub_fields` を再帰処理
- **Repeater**: `sub_fields` を再帰処理（定義のみ、行ごと展開は省略）
- **Flexible Content**: `layouts` 配下の各 `sub_fields` を再帰処理
- **Clone**: `clone` 配列から参照先フィールドを取得して再帰処理

## ライセンス

このプラグインは一時的な移行ツールとして作成されたものです。自由に使用・改変できますが、使用後は削除することを推奨します。

## サポート

このプラグインは「使い捨て」の移行ツールとして設計されているため、継続的なサポートは提供されません。

---

**重要**: 移行完了後は、セキュリティリスクを避けるため、このプラグインファイルを削除してください。
